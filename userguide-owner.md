# トイレチェック管理システム - 管理者向けガイド

**最終更新日:** 2025年12月9日

---

## はじめに

このガイドは、トイレチェック管理システムの管理者向けマニュアルです。
システムの設定、スタッフ管理、チェック状況の確認方法を説明します。

---

## 1. システム構成

トイレチェック管理システムは3つの画面で構成されています:

| 画面 | URL | 用途 | 認証 |
|------|-----|------|------|
| 撮影用PWA | `/capture` | スタッフがトイレチェックを記録 | なし |
| ダッシュボード | `/dashboard` | チェック状況の閲覧 | なし |
| 管理画面 | `/admin` | システム設定・スタッフ管理 | **Basic認証** |

---

## 2. 管理画面へのアクセス

### ログイン方法

1. ブラウザで `https://kj-toilet-frontend.onrender.com/admin` にアクセス
2. ユーザー名とパスワードを入力
3. 「Login」をクリック

**認証情報:**
- ユーザー名: `admin`（デフォルト）
- パスワード: デプロイ時に生成されたパスワード（Render Dashboardで確認）

---

## 3. 管理画面の機能

管理画面には2つのタブがあります:

1. **Staff（スタッフ管理）**
2. **Toilets（トイレ管理）**

---

## 4. スタッフ管理

### スタッフの追加

1. 管理画面で「Staff」タブを選択
2. 「スタッフ追加」ボタンをクリック
3. 以下の情報を入力:
   - **Internal Name（本名）**: スタッフの本名（画面には表示されません）
   - **Icon Code（アイコン）**: 動物絵文字（例: 🐶、🐱、🐭）

4. 「追加」をクリック

**利用可能なアイコン（22種類）:**
```
🐶 🐱 🐭 🐹 🐰 🦊 🐻 🐼 🐨 🐯
🦁 🐮 🐷 🐸 🐵 🐔 🐧 🐦 🦆 🦉
👨‍⚕️ 👩‍⚕️
```

- 👨‍⚕️: 男性医師（ドクター）
- 👩‍⚕️: 女性看護師（ナース）

### スタッフの編集

1. スタッフ一覧から編集したいスタッフの「✏️」（編集）ボタンをクリック
2. 編集モーダルで内部名またはアイコンを変更
3. 「更新」をクリック

### スタッフの並び替え

撮影画面に表示されるスタッフの順序を変更できます:

1. スタッフ一覧の「↑」「↓」ボタンをクリック
2. 順序が即座に更新されます

**活用例:**
- よく使うスタッフを上位に配置
- 退職予定のスタッフを下位に移動

### スタッフの削除（論理削除）

1. スタッフ一覧から削除したいスタッフを見つける
2. ゴミ箱アイコン（🗑️）をクリック
3. 確認ダイアログで「OK」をクリック

**注意:**
- 削除されたスタッフは `is_active = false` になります
- データベースからは削除されません（履歴保持のため）
- 削除されたスタッフは撮影画面に表示されなくなります

### 削除したスタッフの復元

誤って削除したスタッフを復元できます:

1. 「削除済みスタッフを表示」チェックボックスをオンにする
2. 削除済みスタッフがグレー背景で表示されます
3. 復元したいスタッフの「復元」ボタンをクリック
4. 確認ダイアログで「OK」をクリック

### スタッフアイコンの重要性

- **匿名性の確保**: スタッフの名前は撮影画面やダッシュボードに表示されません
- **心理的負担の軽減**: アイコンを使うことで、個人追跡の印象を和らげます
- **ユニーク制約**: 同じアイコンを複数のアクティブスタッフに割り当てることはできません

---

## 5. トイレ管理

### トイレの追加

1. 管理画面で「Toilets」タブを選択
2. 「トイレ追加」ボタンをクリック
3. トイレの名前を入力（例: 「1Fトイレ」、「2Fトイレ」）
4. 「追加」をクリック

**制限:**
- **最大2箇所まで**登録可能です
- 3箇所目を登録しようとするとエラーになります

### トイレ情報の編集

現在のバージョンでは、トイレ情報の編集機能は制限されています。
必要に応じて管理画面から直接操作してください。

---

## 6. ダッシュボードの見方

ダッシュボード (`/dashboard`) では、シンプルな3列のアラート表示でチェック状況を確認できます。

### アラート表示

画面上部に3つのステータスボックスがあります:

| 項目 | 時間帯 | 説明 |
|------|--------|------|
| **朝チェック** | 8:00〜8:50 | 開院前の必須チェック |
| **午後チェック** | 14:00〜14:50 | 午後開院前の必須チェック |
| **定期チェック** | 8:50〜21:00 | 60分間隔のチェック |

### ステータスの色

| 色 | 意味 |
|----|------|
| 🟢 **緑（OK）** | チェック済み / 正常 |
| 🟡 **黄（Warning）** | 前回から50分以上経過 |
| 🔴 **赤（Critical）** | チェック未実施 / 要対応 |

### 履歴テーブル

画面下部には今日のチェック履歴が表示されます:
- **時刻**: チェック実施時刻
- **担当者**: スタッフのアイコン

### 自動更新

- ダッシュボードは**30秒ごと**に自動更新されます
- 常時表示用モニターにも最適です

---

## 7. チェックステータスの判定ロジック

システムは、時間帯と前回チェックからの経過時間に基づいて自動的にステータスを判定します。

### 朝チェック・午後チェック

| 状態 | 条件 |
|------|------|
| 🟢 OK | 時間帯内にチェック完了済み |
| 🟡 Warning | 時間帯中、チェック未実施 |
| 🔴 Critical | 時間帯を過ぎてもチェック未実施 |
| ⚪ Inactive | 時間帯外 |

### 定期チェック（8:50〜21:00）

| 状態 | 条件 |
|------|------|
| 🟢 OK | 前回から60分未満 |
| 🟡 Warning | 前回から50分以上経過 |
| 🔴 Critical | 前回から60分以上経過 |

**昼休み（12:00〜14:00）はチェック対象外です。**

---

## 8. データ管理

### 画像の保存

- 撮影された画像は自動的にサーバーに保存されます
- 保存先: `/var/data/toilet-images/YYYY/MM/DD/{check_id}/`
- ファイル名: `{順番}_{種類}.jpg`
  - 例: `0_sheet.jpg`, `1_overview.jpg`

### 保持期間

- **無期限**: 画像とチェック記録は削除されません
- 容量見積もり:
  - 1チェック: 約200〜800KB
  - 1日（10回チェック）: 約2〜8MB
  - 1ヶ月: 約60〜240MB
  - 1日（10回チェック）: 約2〜8MB
  - 1ヶ月: 約60〜240MB

---

## 9. トラブルシューティング

### ログインできない

- ユーザー名とパスワードを確認してください
- パスワードはRender Dashboardの環境変数 `ADMIN_PASSWORD` で確認できます

### スタッフがアイコンを忘れた

- 管理画面の「Staff」タブで、スタッフ一覧を確認してください
- Internal NameとIcon Codeの紐付けを確認できます

### チェックが記録されていない

1. スタッフの端末がインターネットに接続されているか確認
2. ダッシュボードで最新のチェック履歴を確認
3. 必要に応じてスタッフに再度チェックを依頼

### 画像が表示されない

- ブラウザのキャッシュをクリアしてください
- サーバーの画像ストレージ（Render Disk）が正常に動作しているか確認

---

## 10. 運用のベストプラクティス

### スタッフへの周知

1. 初回導入時、スタッフ全員に以下を伝える:
   - 自分のアイコン
   - 撮影の手順（2枚撮影→アイコン選択）
   - 重要なチェック時間帯（朝8:00〜8:50、午後14:00〜14:50）

2. 定期的にダッシュボードを確認し、アラートが赤になっていないかチェック

### 定期的な確認項目

- **毎日**: ダッシュボードで朝・午後チェックの達成状況を確認
- **毎週**: 全体的なチェック頻度を確認

### アラートへの対応

- **🟡 Warning**: まもなくチェックが必要、スタッフに声掛け
- **🔴 Critical**: すぐにチェックを実施するよう指示

---

## 11. システム仕様の概要

### 技術スタック

- **フロントエンド**: Next.js (PWA対応)
- **バックエンド**: FastAPI (Python)
- **データベース**: PostgreSQL
- **ホスティング**: Render

### セキュリティ

- 管理画面: Basic認証で保護
- 撮影画面・ダッシュボード: 認証なし（院内運用を想定）

### タイムゾーン

- すべて日本時間（Asia/Tokyo）固定

---

## 12. サポート

システムに関するご質問やトラブルは、システム管理者までお問い合わせください。

---

## まとめ

管理者の主な役割:

1. **スタッフ管理**: アイコンの割り当て、編集、並び替え、削除・復元
2. **トイレ管理**: トイレ情報の登録（最大2箇所）
3. **日々の確認**: ダッシュボードでアラート状況を監視

適切な運用により、トイレチェックの確実な実施を実現できます。
