# トイレチェック管理システム - 管理者向けガイド

**最終更新日:** 2025年11月29日

---

## はじめに

このガイドは、トイレチェック管理システムの管理者向けマニュアルです。
システムの設定、スタッフ管理、チェック状況の確認方法を説明します。

---

## 1. システム構成

トイレチェック管理システムは3つの画面で構成されています:

| 画面 | URL | 用途 | 認証 |
|------|-----|------|------|
| 撮影用PWA | `/capture` | スタッフがトイレチェックを記録 | なし |
| ダッシュボード | `/dashboard` | チェック状況の閲覧 | なし |
| 管理画面 | `/admin` | システム設定・スタッフ管理 | **Basic認証** |

---

## 2. 管理画面へのアクセス

### ログイン方法

1. ブラウザで `https://kj-toilet-frontend.onrender.com/admin` にアクセス
2. ユーザー名とパスワードを入力
3. 「Login」をクリック

**認証情報:**
- ユーザー名: `admin`（デフォルト）
- パスワード: デプロイ時に生成されたパスワード（Render Dashboardで確認）

---

## 3. 管理画面の機能

管理画面には3つのタブがあります:

1. **Staff（スタッフ管理）**
2. **Toilets（トイレ管理）**
3. **Checkpoints（主要チェックポイント管理）**

---

## 4. スタッフ管理

### スタッフの追加

1. 管理画面で「Staff」タブを選択
2. 「Add Staff」ボタンをクリック
3. 以下の情報を入力:
   - **Internal Name（本名）**: スタッフの本名（画面には表示されません）
   - **Icon Code（アイコン）**: 動物絵文字（例: 🐶、🐱、🐭）

4. 「保存」をクリック

**利用可能なアイコン（22種類）:**
```
🐶 🐱 🐭 🐹 🐰 🦊 🐻 🐼 🐨 🐯
🦁 🐮 🐷 🐸 🐵 🐔 🐧 🐦 🦆 🦉
👨‍⚕️ 👩‍⚕️
```

- 👨‍⚕️: 男性医師（ドクター）
- 👩‍⚕️: 女性看護師（ナース）

### スタッフの削除（論理削除）

1. スタッフ一覧から削除したいスタッフを見つける
2. ゴミ箱アイコン（🗑️）をクリック
3. 確認ダイアログで「OK」をクリック

**注意:**
- 削除されたスタッフは `is_active = false` になります
- データベースからは削除されません（履歴保持のため）
- 削除されたスタッフは撮影画面に表示されなくなります

### スタッフアイコンの重要性

- **匿名性の確保**: スタッフの名前は撮影画面やダッシュボードに表示されません
- **心理的負担の軽減**: アイコンを使うことで、個人追跡の印象を和らげます
- **ユニーク制約**: 同じアイコンを複数のスタッフに割り当てることはできません

---

## 5. トイレ管理

### トイレの追加

1. 管理画面で「Toilets」タブを選択
2. 「Add Toilet」ボタンをクリック
3. トイレの名前を入力（例: 「1Fトイレ」、「2Fトイレ」）
4. 「保存」をクリック

**制限:**
- **最大2箇所まで**登録可能です
- 3箇所目を登録しようとするとエラーになります

### トイレ情報の編集

現在のバージョンでは、トイレ情報の編集機能は制限されています。
必要に応じて管理画面から直接操作してください。

---

## 6. 主要チェックポイント管理

主要チェックポイントは、特に重要な時間帯のチェックを監視する機能です。

### デフォルト設定

| ラベル | 時間帯 | 説明 |
|--------|--------|------|
| 開院前 | 08:30–08:50 | 開院準備として必須 |
| 午前終了時 | 12:00–13:00 | 昼休み前の確認 |
| 午後開始前 | 14:40–14:50 | 午後診療開始前 |
| 閉院時 | 19:30–20:30 | 閉院時の最終確認 |

### チェックポイントの追加・編集

1. 管理画面で「Checkpoints」タブを選択
2. 現在のチェックポイント一覧が表示されます
3. 必要に応じて追加・編集が可能です（現在は基本機能のみ実装）

**注意:**
- 診療時間とは独立して管理されます
- 例: 診療時間が09:00開院でも、「開院前チェック」は08:30-08:50として設定可能

---

## 7. ダッシュボードの見方

ダッシュボード (`/dashboard`) では、トイレチェックの実施状況を3つのビューで確認できます。

### Day View（日次ビュー）

**主要チェックポイント一覧:**
- ⏳ **まだ**: 時間帯前
- ✅ **完了**: 時間帯内に1件以上のチェックあり
- 🔴 **未実施**: 時間帯終了後もチェックなし

**リアルタイムアラート:**
- ⚠️ **警告**: 前回から75分経過
- 🔴 **アラート**: 前回から90分経過（要対応）

**タイムライン:**
- 1日のチェック履歴を時系列で表示
- 色分け:
  - 🟢 緑: 正常（45〜90分間隔）
  - 🟡 黄: 短すぎ（45分未満）
  - 🔴 赤: 長すぎ（90分超過）
- アイコン: 撮影者のアイコン
- サムネイル: クリックで拡大表示

### Week View（週次ビュー）

- 1週間の実施率をヒートマップで表示
- 日付をクリックすると、その日のDay Viewに遷移

### Month View（月次ビュー）

- カレンダー形式で1ヶ月の実施状況を表示
- 日別の実施率を色で表示

---

## 8. システム設定（今後実装予定）

将来のバージョンでは、以下の設定が可能になります:

### 診療時間設定
- 開院時刻
- 昼休み開始・終了
- 閉院時刻

### タイムライン表示設定
- 表示開始時刻（デフォルト: 07:00）
- 表示終了時刻（デフォルト: 22:00）

---

## 9. データ管理

### 画像の保存

- 撮影された画像は自動的にサーバーに保存されます
- 保存先: `/var/data/toilet-images/YYYY/MM/DD/{check_id}/`
- ファイル名: `{順番}_{種類}.jpg`
  - 例: `0_sheet.jpg`, `1_overview.jpg`, `2_extra.jpg`

### 保持期間

- **無期限**: 画像とチェック記録は削除されません
- 容量見積もり:
  - 1チェック: 約200〜800KB
  - 1日（10回チェック）: 約2〜8MB
  - 1ヶ月: 約60〜240MB

---

## 10. チェックステータスの判定ロジック

システムは、前回のチェックからの経過時間に基づいて自動的にステータスを判定します。

### ステータスの種類

| ステータス | 色 | 条件 |
|-----------|-----|------|
| NORMAL | 🟢 緑 | 45〜90分以内 |
| TOO_SHORT | 🟡 黄 | 45分未満 |
| TOO_LONG | 🔴 赤 | 90分超過 |

### リアルタイムアラート

| 経過時間 | アラート |
|----------|----------|
| 75分経過 | ⚠️ 警告表示 |
| 90分経過 | 🔴 アラート表示 |

---

## 11. トラブルシューティング

### ログインできない

- ユーザー名とパスワードを確認してください
- パスワードはRender Dashboardの環境変数 `ADMIN_PASSWORD` で確認できます

### スタッフがアイコンを忘れた

- 管理画面の「Staff」タブで、スタッフ一覧を確認してください
- Internal NameとIcon Codeの紐付けを確認できます

### チェックが記録されていない

1. スタッフの端末がインターネットに接続されているか確認
2. ダッシュボードで最新のチェック履歴を確認
3. 必要に応じてスタッフに再度チェックを依頼

### 画像が表示されない

- ブラウザのキャッシュをクリアしてください
- サーバーの画像ストレージ（Render Disk）が正常に動作しているか確認

---

## 12. 運用のベストプラクティス

### スタッフへの周知

1. 初回導入時、スタッフ全員に以下を伝える:
   - 自分のアイコン
   - 撮影の手順
   - 主要チェックポイントの時間帯

2. 定期的にダッシュボードを確認し、未実施の時間帯がないかチェック

### 定期的な確認項目

- **毎日**: ダッシュボードで主要チェックポイントの達成状況を確認
- **毎週**: Week Viewで1週間の実施率を確認
- **毎月**: Month Viewで月間の傾向を把握

### アラートへの対応

- **⚠️ 警告（75分）**: まもなく90分になるため、スタッフに声掛け
- **🔴 アラート（90分）**: すぐにチェックを実施するよう指示

---

## 13. システム仕様の概要

### 技術スタック

- **フロントエンド**: Next.js (PWA対応)
- **バックエンド**: FastAPI (Python)
- **データベース**: PostgreSQL
- **ホスティング**: Render

### セキュリティ

- 管理画面: Basic認証で保護
- 撮影画面・ダッシュボード: 認証なし（院内運用を想定）

### タイムゾーン

- すべて日本時間（Asia/Tokyo）固定

---

## 14. サポート

システムに関するご質問やトラブルは、システム管理者までお問い合わせください。

---

## まとめ

管理者の主な役割:

1. **スタッフ管理**: アイコンの割り当てと削除
2. **トイレ管理**: トイレ情報の登録（最大2箇所）
3. **主要チェックポイント設定**: 重要な時間帯の監視
4. **日々の確認**: ダッシュボードでチェック状況を監視

適切な運用により、トイレチェックの確実な実施を実現できます。
