# 今後の開発計画と改善点 (Future Roadmap)

現在のコードベース（フェーズB完了時点）のレビュー結果に基づき、未実装機能、改善が必要な点、および将来の拡張案をまとめました。

## 1. 未実装機能 (Missing Features)

### 管理画面 (Admin UI)
- [x] **主要チェックポイントの編集機能**:
    - 実装完了: 一覧表示、追加、編集、削除（CRUD）が可能になりました。
- [x] **システム設定 (Clinic Config) のUI**:
    - 実装完了: 開院時間、昼休み、タイムライン表示範囲などの設定変更が可能になりました。
- [ ] **並び替え機能**:
    - スタッフやチェックポイントの表示順 (`display_order`) を変更するUIが未実装です。現在は追加順またはDB直接編集に依存しています。

### ダッシュボード (Dashboard)
- [ ] **週間・月間ビュー (Week/Month View)**:
    - 現在は「日次ビュー (Day View)」のみ実装されています。
    - ヒートマップやカレンダー形式での長期的な傾向分析機能が未実装です。
- [ ] **全トイレ俯瞰ビュー**:
    - 現在はプルダウンでトイレを切り替える形式ですが、複数のトイレの状況を一度に確認できるサマリービューがあると便利です。

## 2. 改善・リファクタリング (Improvements)

### バックエンド
- [x] **タイムゾーン処理の堅牢化**:
    - `datetime.now(timezone.utc)` を使用し、DB保存値のタイムゾーン情報を考慮するよう修正しました。これにより `TypeError` は解消されました。
- [ ] **画像パスの処理**:
    - `dashboard.py` 内で `os.path.relpath` を使用してパスを生成していますが、静的ファイル配信の構成と密結合しています。将来的にS3などに移行する場合はロジックの変更が必要です。

### フロントエンド
- [ ] **型定義の共有**:
    - APIレスポンスの型定義が `types.ts` にありますが、バックエンドのPydanticモデルと手動で同期する必要があります。`openapi-typescript` などのツール導入を検討してください。
- [ ] **エラーハンドリングの強化**:
    - ネットワークエラーやAPIエラー時のユーザーへのフィードバック（トースト通知など）をより詳細に行う余地があります。現在は `alert()` やコンソールログが主です。

## 3. バグ・懸念点 (Known Issues)

- **画像ストレージ**: RenderのDiskを使用していますが、永続化ディスクの容量監視や古い画像のアーカイブ/削除ポリシー（現在は無期限保存）について検討が必要です。
- **認証**: Basic認証は簡易的です。セキュリティ要件が高まる場合は、JWTやセッションベースの認証への移行を検討してください。

## 4. 将来プラン (Future Plans)

### AS-IS / TO-BE 比較

#### 📷 撮影フロー

| 項目 | AS-IS (現状) | TO-BE (将来) |
|------|-------------|--------------|
| 撮影手順 | ①撮影 → ②プレビュー確認 → ③スタッフ選択 → ④送信 | ①撮影 → ②スタッフ選択 → ③即座に送信（確認スキップ） |
| 画像枚数 | 最低2枚必要（2枚未満は次へ進めない） | 同様（または設定で変更可能に） |
| 確認画面 | なし（プレビューはあるが送信前確認なし） | 「撮影後確認スキップ」オプション追加 |

#### 📊 ダッシュボード

| 項目 | AS-IS (現状) | TO-BE (将来) |
|------|-------------|--------------|
| **表示内容** | ・主要チェックポイント（4枠）<br>・アラート（長時間未チェック）<br>・タイムライン（履歴一覧） | ・シンプルな〇△×表示のみ<br>・一目で状況把握可能 |
| **チェック判定** | completed / missed / pending の3状態 | 🟢〇 / 🟡△ / 🔴× の3段階アラート |
| **判定ロジック** | 設定時刻までにチェックしたか | 以下の時間ベースルール適用 |
| **情報量** | 多い（チェックポイント、アラート、タイムライン） | 最小限（状況が一目でわかる） |

#### ⏰ 時間ベースの判定ルール（TO-BE）

| チェックタイミング | 期限 | 🟢〇 | 🟡△ | 🔴× |
|---|---|---|---|---|
| **朝の開院前** | 8:50まで | 8:50以前に完了 | 8:50〜9:50の間 | 9:50以降または未実施 |
| **午後開院前** | 14:50まで | 14:50以前に完了 | 14:50〜15:50の間 | 15:50以降または未実施 |
| **通常チェック** | 前回から1時間 | 1時間以内 | 1〜2時間 | 2時間以上経過 |

#### 🖥️ ダッシュボードUI比較

**AS-IS（現状）**
```
┌─────────────────────────────────┐
│ トイレ管理ダッシュボード        │
├─────────────────────────────────┤
│ [主要チェックポイント]          │
│ ┌─────────┐ ┌─────────┐        │
│ │開院前   │ │昼前     │        │
│ │✓ 8:45  │ │✓ 11:30 │        │
│ └─────────┘ └─────────┘        │
│ ┌─────────┐ ┌─────────┐        │
│ │午後開院前│ │終業前   │        │
│ │✓ 14:40 │ │-- --:-- │        │
│ └─────────┘ └─────────┘        │
├─────────────────────────────────┤
│ [アラート]                      │
│ ⚠️ トイレA: 45分経過           │
├─────────────────────────────────┤
│ [タイムライン]                  │
│ 🧑 14:40 正常                  │
│ 👩 11:30 正常                  │
│ 🧔 8:45  正常                  │
│ ... (スクロールで履歴続く)      │
└─────────────────────────────────┘
```

**TO-BE（将来）**
```
┌─────────────────────────────────┐
│ トイレチェック状況              │
├─────────────────────────────────┤
│                                 │
│  朝チェック(〜8:50)    🟢 8:45 │
│                                 │
│  午後チェック(〜14:50) 🟢14:40 │
│                                 │
│  定期チェック          🟡      │
│  └ 前回から52分経過            │
│    (あと8分でチェック推奨)      │
│                                 │
└─────────────────────────────────┘
※ タップで詳細履歴表示
```

### カメラ撮影フローの改善
- [ ] **撮影後の確認画面スキップオプション**:
    - 現在は撮影後にプレビュー確認画面が表示されますが、素早い運用のために確認をスキップして即座に送信できるオプションを追加予定です。
    - 設定画面で「撮影後の確認をスキップ」のON/OFF切り替えを実装します。

### ダッシュボードのシンプル化
- [ ] **トイレ管理ダッシュボードのUI簡素化**:
    - 現在のダッシュボードをより直感的でシンプルなデザインに改善します。
    - 情報の優先度を見直し、最も重要な情報（最新チェック状況）を目立たせます。
    - 不要な要素を削減し、一目で状況が把握できるUIを目指します。

### トイレチェックのアラート機能
- [ ] **時間ベースのチェック状況表示**:
    - 以下のルールでチェック状況を〇△×で表示するシンプルなダッシュボード:
    
    | チェックタイミング | 期限 | 判定基準 |
    |---|---|---|
    | 朝の開院前チェック | 8:50まで | 〇：期限内 / △：遅れ / ×：1時間以上遅れ |
    | 通常チェック（約1時間ごと） | 前回から1時間以内 | 〇：1時間以内 / △：1時間超過 / ×：2時間以上超過 |
    | 午後開院前チェック | 14:50まで | 〇：期限内 / △：遅れ / ×：1時間以上遅れ |

    - **表示イメージ**:
      ```
      トイレA: 🟢 朝チェック済(8:45) | 🟡 次回チェックまであと10分
      トイレB: 🔴 チェック遅延中（前回から1時間30分経過）
      ```
    
    - **アラート色の定義**:
      - 🟢 (〇): 規定時間内にチェック完了
      - 🟡 (△): 遅延あり（1時間以内の遅れ）
      - 🔴 (×): 大幅遅延（1時間以上の遅れ）

---

このドキュメントは、次のフェーズ（フェーズC以降）の開発指針として活用してください。
