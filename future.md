# 今後の開発計画と改善点 (Future Roadmap)

現在のコードベース（フェーズB完了時点）のレビュー結果に基づき、未実装機能、改善が必要な点、および将来の拡張案をまとめました。

## 1. 未実装機能 (Missing Features)

### 管理画面 (Admin UI)
- [x] **主要チェックポイントの編集機能**:
    - 実装完了: 一覧表示、追加、編集、削除（CRUD）が可能になりました。
- [x] **システム設定 (Clinic Config) のUI**:
    - 実装完了: 開院時間、昼休み、タイムライン表示範囲などの設定変更が可能になりました。
- [ ] **並び替え機能**:
    - スタッフやチェックポイントの表示順 (`display_order`) を変更するUIが未実装です。現在は追加順またはDB直接編集に依存しています。

### ダッシュボード (Dashboard)
- [ ] **週間・月間ビュー (Week/Month View)**:
    - 現在は「日次ビュー (Day View)」のみ実装されています。
    - ヒートマップやカレンダー形式での長期的な傾向分析機能が未実装です。
- [ ] **全トイレ俯瞰ビュー**:
    - 現在はプルダウンでトイレを切り替える形式ですが、複数のトイレの状況を一度に確認できるサマリービューがあると便利です。

## 2. 改善・リファクタリング (Improvements)

### バックエンド
- [x] **タイムゾーン処理の堅牢化**:
    - `datetime.now(timezone.utc)` を使用し、DB保存値のタイムゾーン情報を考慮するよう修正しました。これにより `TypeError` は解消されました。
- [ ] **画像パスの処理**:
    - `dashboard.py` 内で `os.path.relpath` を使用してパスを生成していますが、静的ファイル配信の構成と密結合しています。将来的にS3などに移行する場合はロジックの変更が必要です。

### フロントエンド
- [ ] **型定義の共有**:
    - APIレスポンスの型定義が `types.ts` にありますが、バックエンドのPydanticモデルと手動で同期する必要があります。`openapi-typescript` などのツール導入を検討してください。
- [ ] **エラーハンドリングの強化**:
    - ネットワークエラーやAPIエラー時のユーザーへのフィードバック（トースト通知など）をより詳細に行う余地があります。現在は `alert()` やコンソールログが主です。

## 3. バグ・懸念点 (Known Issues)

- **画像ストレージ**: RenderのDiskを使用していますが、永続化ディスクの容量監視や古い画像のアーカイブ/削除ポリシー（現在は無期限保存）について検討が必要です。
- **認証**: Basic認証は簡易的です。セキュリティ要件が高まる場合は、JWTやセッションベースの認証への移行を検討してください。

## 4. 将来プラン (Future Plans)

### AS-IS / TO-BE 比較

#### 📷 撮影フロー

| 項目 | AS-IS (旧) | TO-BE (実装済み) |
|------|-------------|----------------|
| 撮影方式 | スマホカメラアプリ起動（確認画面あり） | WebRTCカメラ（ブラウザ内で即座にキャプチャ） |
| 撮影手順 | ①撮影 → ②スマホ確認画面 → ③「次へ進む」タップ → ④スタッフ選択 → ⑤送信 | ①シャッタータップ×2 → ②自動でスタッフ選択画面 → ③送信 |
| 操作回数 | 5タップ（撮影×2 + 確認×2 + 次へ + スタッフ） | 3タップ（シャッター×2 + スタッフ） |
| 所要時間 | 約15秒 | 約6秒 |
| UI | 丸ボタン（カメラアイコン） | 全画面カメラプレビュー + シャッターボタン |

#### 📊 ダッシュボード

| 項目 | AS-IS (現状) | TO-BE (実装済み) |
|------|-------------|--------------|
| **表示内容** | ・主要チェックポイント（4枠）<br>・アラート（長時間未チェック）<br>・タイムライン（履歴一覧） | ・横3列のシンプルなアラートボックス<br>・下部に履歴テーブル |
| **チェック判定** | completed / missed / pending の3状態 | ⏳待機 / 🟡警告 / 🔴アラート / 🟢OK |
| **判定ロジック** | 設定時刻までにチェックしたか | 時間帯開始で警告→期限超過でアラート→完了でOK |
| **情報量** | 多い（チェックポイント、アラート、タイムライン） | 最小限（状況が一目でわかる） |

#### ⏰ 時間ベースの判定ルール（実装済み）

| チェックタイミング | 時間帯 | ⏳待機中 | 🟡警告 | 🔴アラート | 🟢OK |
|---|---|---|---|---|---|
| **朝チェック** | 8:00〜8:50 | 8:00より前 | 8:00〜8:50（未） | 8:50以降（未） | チェック完了 |
| **午後チェック** | 14:00〜14:50 | 14:00より前 | 14:00〜14:50（未） | 14:50以降（未） | チェック完了 |
| **定期チェック** | 8:50〜21:00 | - | 60〜120分経過 | 120分以上 | 60分以内 |

**ポイント**:
- 朝/午後チェックは開始時刻から黄色警告でスタート（チェックを促す）
- 期限を過ぎると赤アラート
- チェック完了すれば、期限後でも緑OK＋時刻表示

#### 🖥️ ダッシュボードUI比較

**AS-IS（旧）**
```
┌─────────────────────────────────┐
│ トイレ管理ダッシュボード        │
├─────────────────────────────────┤
│ [主要チェックポイント]          │
│ ┌─────────┐ ┌─────────┐        │
│ │開院前   │ │昼前     │        │
│ │✓ 8:45  │ │✓ 11:30 │        │
│ └─────────┘ └─────────┘        │
│ ┌─────────┐ ┌─────────┐        │
│ │午後開院前│ │終業前   │        │
│ │✓ 14:40 │ │-- --:-- │        │
│ └─────────┘ └─────────┘        │
├─────────────────────────────────┤
│ [アラート]                      │
│ ⚠️ トイレA: 45分経過           │
├─────────────────────────────────┤
│ [タイムライン]                  │
│ 🧑 14:40 正常                  │
│ 👩 11:30 正常                  │
│ 🧔 8:45  正常                  │
│ ... (スクロールで履歴続く)      │
└─────────────────────────────────┘
```

**TO-BE（実装済み）**
```
┌──────────────────────────────────────────────────────┐
│  トイレチェック                           10:30現在  │
├──────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │朝 〜8:50 │  │午後〜14:50│  │  定期    │          │
│  │   🟢    │  │   🟡    │  │   🟢    │          │
│  │  8:45   │  │  警告中  │  │  45分   │          │
│  └──────────┘  └──────────┘  └──────────┘          │
├──────────────────────────────────────────────────────┤
│  本日のチェック履歴                                  │
│   時刻    担当                                       │
│  ─────────────                                       │
│   09:15   🧑                                         │
│   08:45   👩                                         │
└──────────────────────────────────────────────────────┘
```

### カメラ撮影フローの改善
- [x] **WebRTCカメラに変更（スマホ確認画面スキップ）**:
    - 実装完了: `<input type="file" capture>` から `navigator.mediaDevices.getUserMedia()` に変更
    - ブラウザ内でカメラプレビューを表示し、タップで即座にキャプチャ
    - スマホのカメラアプリ確認画面を完全にバイパス
- [x] **「次へ進む」ボタン削除**:
    - 実装完了: 2枚撮影後に自動でスタッフ選択画面へ遷移
- [x] **UI改善**:
    - 全画面カメラプレビュー（黒背景）
    - 撮影枚数表示（N/2枚）
    - 「あと1枚！」オーバーレイ表示
    - シャッターボタン（白丸）

### ダッシュボードのシンプル化
- [x] **トイレ管理ダッシュボードのUI簡素化**:
    - 実装完了: 横3列のシンプルなアラートボックス + 下部に履歴テーブル
    - 朝チェック / 午後チェック / 定期チェックの3ステータス
    - 🟢🟡🔴の色分けで一目で状況把握

### トイレチェックのアラート機能
- [x] **時間ベースのチェック状況表示**:
    - 実装完了: `/api/simple-status` エンドポイントで以下の判定を実装
    
    | チェックタイミング | 時間帯 | 判定ルール |
    |---|---|---|
    | 朝チェック | 8:00〜8:50 | ⚙️待機(8:00前) → 🟡警告(8:00-8:50) → 🔴アラート(8:50以降) → 🟢OK(完了) |
    | 午後チェック | 14:00〜14:50 | ⚙️待機(14:00前) → 🟡警告(14:00-14:50) → 🔴アラート(14:50以降) → 🟢OK(完了) |
    | 定期チェック | 8:50〜21:00 | 🟢OK(60分以内) → 🟡警告(60-120分) → 🔴アラート(120分以上) |

---

このドキュメントは、次のフェーズ（フェーズC以降）の開発指針として活用してください。
